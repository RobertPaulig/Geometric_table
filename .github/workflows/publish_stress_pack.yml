name: publish-stress-evidence-pack

permissions:
  actions: write
  contents: write
  pull-requests: write

on:
  workflow_dispatch:
    inputs:
      ref:
        description: "Git ref to run on (branch, tag, or SHA). Example: main or 9c54b043..."
        required: true
        default: "main"
      tag:
        description: "Release tag to create/update. Example: stress-10k-2026-01-05"
        required: true
      rows:
        description: "Number of rows to generate in stress CSV"
        required: true
        default: "10000"
      k_decoys:
        description: "k_decoys for hetero2-batch"
        required: true
        default: "2"
      workers:
        description: "workers for hetero2-batch"
        required: true
        default: "1"
      timeout_s:
        description: "timeout_s for hetero2-batch"
        required: true
        default: "60"
      seed:
        description: "seed for hetero2-batch"
        required: true
        default: "0"
      physics_mode:
        description: "physics_mode for hetero2-batch (topological|hamiltonian|both)"
        required: true
        default: "topological"
      edge_weight_mode:
        description: "edge_weight_mode for hetero2-batch (unweighted|bond_order|bond_order_delta_chi)"
        required: true
        default: "unweighted"
      potential_mode:
        description: "potential_mode for hetero2-batch (static|self_consistent|both)"
        required: true
        default: "static"
      scf_max_iter:
        description: "SCF max iterations (self_consistent/both)"
        required: true
        default: "50"
      scf_tol:
        description: "SCF convergence tolerance (inf-norm of dV)"
        required: true
        default: "1e-6"
      scf_damping:
        description: "SCF damping in (0,1]"
        required: true
        default: "0.5"
      scf_occ_k:
        description: "SCF number of lowest eigenstates to use"
        required: true
        default: "5"
      scf_tau:
        description: "SCF temperature for soft weights"
        required: true
        default: "1.0"
      integrator_mode:
        description: "integrator_mode for DOS/LDOS integration (baseline|adaptive|both)"
        required: true
        default: "baseline"
      integrator_eps_abs:
        description: "adaptive abs tolerance (P4.1)"
        required: true
        default: "1e-6"
      integrator_eps_rel:
        description: "adaptive rel tolerance (P4.1)"
        required: true
        default: "1e-4"
      integrator_subdomains_max:
        description: "adaptive subdomains_max (P4.1)"
        required: true
        default: "64"
      integrator_poly_degree_max:
        description: "adaptive poly_degree_max (P4.1)"
        required: true
        default: "8"
      integrator_quad_order_max:
        description: "adaptive quad_order_max (P4.1)"
        required: true
        default: "16"
      integrator_eval_budget_max:
        description: "adaptive eval_budget_max (P4.1)"
        required: true
        default: "4096"
      integrator_split_criterion:
        description: "adaptive split_criterion label (audit/logging) (P4.1)"
        required: true
        default: "max_abs_error"
      prerelease:
        description: "Mark GitHub release as pre-release"
        required: true
        default: "true"

jobs:
  build-pack:
    runs-on: ubuntu-latest
    outputs:
      sha256: ${{ steps.hash.outputs.sha256 }}
      source_sha: ${{ steps.meta.outputs.source_sha }}
      asset_url: ${{ steps.meta.outputs.asset_url }}

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install (dev,chem)
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev,chem]"

      - name: Generate stress CSV
        run: |
          python scripts/generate_stress_csv.py \
            --out stress.csv \
            --rows ${{ inputs.rows }}

      - name: Run hetero2-batch (light + zip_pack)
        run: |
          hetero2-batch \
            --input stress.csv \
            --out_dir out_stress \
            --artifacts light \
            --score_mode mock \
            --k_decoys ${{ inputs.k_decoys }} \
            --workers ${{ inputs.workers }} \
            --timeout_s ${{ inputs.timeout_s }} \
            --maxtasksperchild 100 \
            --seed_strategy per_row \
            --seed ${{ inputs.seed }} \
            --physics_mode ${{ inputs.physics_mode }} \
            --edge_weight_mode ${{ inputs.edge_weight_mode }} \
            --potential_mode ${{ inputs.potential_mode }} \
            --scf_max_iter ${{ inputs.scf_max_iter }} \
            --scf_tol ${{ inputs.scf_tol }} \
            --scf_damping ${{ inputs.scf_damping }} \
            --scf_occ_k ${{ inputs.scf_occ_k }} \
            --scf_tau ${{ inputs.scf_tau }} \
            --integrator_mode ${{ inputs.integrator_mode }} \
            --integrator_eps_abs ${{ inputs.integrator_eps_abs }} \
            --integrator_eps_rel ${{ inputs.integrator_eps_rel }} \
            --integrator_subdomains_max ${{ inputs.integrator_subdomains_max }} \
            --integrator_poly_degree_max ${{ inputs.integrator_poly_degree_max }} \
            --integrator_quad_order_max ${{ inputs.integrator_quad_order_max }} \
            --integrator_eval_budget_max ${{ inputs.integrator_eval_budget_max }} \
            --integrator_split_criterion ${{ inputs.integrator_split_criterion }} \
            --zip_pack

      - name: Validate zip (no unpack)
        run: |
          python -m zipfile -t out_stress/evidence_pack.zip
          python -m zipfile -l out_stress/evidence_pack.zip | grep -E "manifest.json|checksums.sha256|metrics.json|index.md|summary.csv"

      - name: Compute SHA256
        id: hash
        run: |
          SHA256=$(sha256sum out_stress/evidence_pack.zip | awk '{print toupper($1)}')
          echo "sha256=$SHA256" >> "$GITHUB_OUTPUT"
          echo "$SHA256  evidence_pack.zip" > out_stress/evidence_pack.zip.sha256

      - name: Write release notes
        run: |
          cat > release_notes.md << 'EOF'
          stress_10k evidence pack (light artifacts)

          - Source ref: ${{ inputs.ref }}
          - Batch (repro):
            hetero2-batch --input stress.csv --out_dir out_stress --artifacts light --score_mode mock --k_decoys ${{ inputs.k_decoys }} --workers ${{ inputs.workers }} --timeout_s ${{ inputs.timeout_s }} --maxtasksperchild 100 --seed_strategy per_row --seed ${{ inputs.seed }} --physics_mode ${{ inputs.physics_mode }} --edge_weight_mode ${{ inputs.edge_weight_mode }} --potential_mode ${{ inputs.potential_mode }} --scf_max_iter ${{ inputs.scf_max_iter }} --scf_tol ${{ inputs.scf_tol }} --scf_damping ${{ inputs.scf_damping }} --scf_occ_k ${{ inputs.scf_occ_k }} --scf_tau ${{ inputs.scf_tau }} --integrator_mode ${{ inputs.integrator_mode }} --integrator_eps_abs ${{ inputs.integrator_eps_abs }} --integrator_eps_rel ${{ inputs.integrator_eps_rel }} --integrator_subdomains_max ${{ inputs.integrator_subdomains_max }} --integrator_poly_degree_max ${{ inputs.integrator_poly_degree_max }} --integrator_quad_order_max ${{ inputs.integrator_quad_order_max }} --integrator_eval_budget_max ${{ inputs.integrator_eval_budget_max }} --integrator_split_criterion ${{ inputs.integrator_split_criterion }} --zip_pack
          - Pack: summary.csv, metrics.json, index.md, manifest.json, checksums.sha256, evidence_pack.zip
          - SHA256(evidence_pack.zip): ${{ steps.hash.outputs.sha256 }}
          EOF

      - name: Prepare meta (asset URL, source SHA)
        id: meta
        run: |
          SOURCE_SHA=$(git rev-parse HEAD)
          echo "source_sha=$SOURCE_SHA" >> "$GITHUB_OUTPUT"
          ASSET_URL="https://github.com/${{ github.repository }}/releases/download/${{ inputs.tag }}/evidence_pack.zip"
          echo "asset_url=$ASSET_URL" >> "$GITHUB_OUTPUT"

      - name: "Gate: ERROR must be 0"
        run: |
          python - << 'PY'
          import json
          m = json.load(open("out_stress/metrics.json", "r", encoding="utf-8"))
          err = int(m.get("counts", {}).get("ERROR", 0))
          assert err == 0, f"Gate-Stress failed: ERROR={err}"
          print("Gate OK: ERROR=0")
          PY

      - name: Upload build artifact (zip)
        uses: actions/upload-artifact@v4
        with:
          name: evidence-pack
          path: |
            out_stress/evidence_pack.zip
            out_stress/evidence_pack.zip.sha256
            release_notes.md

  publish-release:
    needs: build-pack
    runs-on: ubuntu-latest

    steps:
      - uses: actions/download-artifact@v4
        with:
          name: evidence-pack
          path: .

      - name: Create/Update GitHub Release + upload asset
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.tag }}
          target_commitish: ${{ needs.build-pack.outputs.source_sha }}
          name: "stress_10k light evidence pack (ERROR=0)"
          body_path: release_notes.md
          prerelease: ${{ inputs.prerelease }}
          files: |
            out_stress/evidence_pack.zip
            out_stress/evidence_pack.zip.sha256
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  registry-pr:
    needs: [build-pack, publish-release]
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          ref: "main"

      - name: Update artefacts registry (append)
        run: |
          mkdir -p docs
          FILE="docs/artefacts_registry.md"
          if [ ! -f "$FILE" ]; then
            echo "# Artefacts Registry" > "$FILE"
            echo "" >> "$FILE"
          fi

          cat >> "$FILE" << EOF

          ## ${{ inputs.tag }}

          - Source commit: ${{ needs.build-pack.outputs.source_sha }}
          - Release asset: ${{ needs.build-pack.outputs.asset_url }}
          - SHA256(evidence_pack.zip): ${{ needs.build-pack.outputs.sha256 }}
          - Command:
            hetero2-batch --input stress.csv --out_dir out_stress --artifacts light --score_mode mock --k_decoys ${{ inputs.k_decoys }} --workers ${{ inputs.workers }} --timeout_s ${{ inputs.timeout_s }} --maxtasksperchild 100 --seed_strategy per_row --seed ${{ inputs.seed }} --physics_mode ${{ inputs.physics_mode }} --edge_weight_mode ${{ inputs.edge_weight_mode }} --potential_mode ${{ inputs.potential_mode }} --scf_max_iter ${{ inputs.scf_max_iter }} --scf_tol ${{ inputs.scf_tol }} --scf_damping ${{ inputs.scf_damping }} --scf_occ_k ${{ inputs.scf_occ_k }} --scf_tau ${{ inputs.scf_tau }} --integrator_mode ${{ inputs.integrator_mode }} --integrator_eps_abs ${{ inputs.integrator_eps_abs }} --integrator_eps_rel ${{ inputs.integrator_eps_rel }} --integrator_subdomains_max ${{ inputs.integrator_subdomains_max }} --integrator_poly_degree_max ${{ inputs.integrator_poly_degree_max }} --integrator_quad_order_max ${{ inputs.integrator_quad_order_max }} --integrator_eval_budget_max ${{ inputs.integrator_eval_budget_max }} --integrator_split_criterion ${{ inputs.integrator_split_criterion }} --zip_pack
          EOF

      - name: Create PR with registry update
        id: registry_cpr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: "automation/artefact-${{ inputs.tag }}"
          title: "Add artefact registry entry for ${{ inputs.tag }}"
          commit-message: "docs: add artefact registry entry for ${{ inputs.tag }}"
          body: |
            Automated update: appended artefact entry after publishing release asset.
          base: "main"
          add-paths: |
            docs/artefacts_registry.md

      - name: Trigger CI (pytest workflow_dispatch) for automation PR branch
        if: steps.registry_cpr.outputs.pull-request-url != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          BRANCH: "automation/artefact-${{ inputs.tag }}"
          PR_URL: ${{ steps.registry_cpr.outputs.pull-request-url }}
        run: |
          set -euo pipefail
          echo "Automation PR: $PR_URL"
          echo "Triggering pytest workflow on branch: $BRANCH"

          gh workflow run pytest.yml --ref "$BRANCH" --repo "$REPO"

          RUN_ID=""
          for i in $(seq 1 30); do
            RUN_ID=$(gh run list --workflow pytest.yml --branch "$BRANCH" --event workflow_dispatch --limit 1 --json databaseId --jq '.[0].databaseId' --repo "$REPO" 2>/dev/null || true)
            if [ -n "$RUN_ID" ] && [ "$RUN_ID" != "null" ]; then
              break
            fi
            sleep 2
          done

          if [ -z "$RUN_ID" ] || [ "$RUN_ID" = "null" ]; then
            echo "ERROR: failed to locate dispatched pytest run"
            gh run list --workflow pytest.yml --branch "$BRANCH" --limit 5 --repo "$REPO" || true
            exit 1
          fi

          RUN_URL=$(gh run view "$RUN_ID" --json url --jq '.url' --repo "$REPO")
          TESTED_SHA=$(gh run view "$RUN_ID" --json headSha --jq '.headSha' --repo "$REPO")
          echo "pytest run url: $RUN_URL"
          echo "tested_sha: $TESTED_SHA"

          gh run watch "$RUN_ID" --exit-status --repo "$REPO"
