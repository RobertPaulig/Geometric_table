name: publish-value-known-bad-good

permissions:
  contents: write
  pull-requests: write
  statuses: read

on:
  workflow_dispatch:
    inputs:
      ref:
        description: "Git ref to run on (branch, tag, or SHA). Example: main or 9c54b043..."
        required: true
        default: "main"
      tag:
        description: "Release tag to create/update. Must match: value-known-bad-good-YYYY-MM-DD"
        required: true
      prerelease:
        description: "Mark GitHub release as pre-release"
        required: true
        default: "true"
      suite_rows:
        description: "Rows to generate for the frozen ring-suite input"
        required: true
        default: "200"
      k_decoys:
        description: "k_decoys for suite generation + hetero2-batch"
        required: true
        default: "20"
      scores_seed:
        description: "Seed for BAD-random scores"
        required: true
        default: "0"

jobs:
  build-packs:
    runs-on: ubuntu-latest
    outputs:
      source_sha: ${{ steps.meta.outputs.source_sha }}
      asset_urls_json: ${{ steps.meta.outputs.asset_urls_json }}
      sha256_json: ${{ steps.hash.outputs.sha256_json }}
      summary_json: ${{ steps.summary.outputs.summary_json }}

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}

      - name: Validate tag format
        run: |
          echo "${{ inputs.tag }}" | grep -E '^value-known-bad-good-[0-9]{4}-[0-9]{2}-[0-9]{2}$'

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install (dev,chem)
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev,chem]"

      - name: Generate frozen ring-suite input (same as VALUE-M1)
        run: |
          python scripts/pilot_generate_input.py \
            --out_dir out_value_m2/suite \
            --rows ${{ inputs.suite_rows }} \
            --k_decoys ${{ inputs.k_decoys }} \
            --seed 0 \
            --full_cover_count 3

      - name: Build scores variants (BAD-constant / BAD-random / GOOD-synthetic)
        run: |
          python - << 'PY'
          import json
          import os
          from pathlib import Path
          
          import numpy as np
          
          from scripts.pilot_generate_input import SMILES_LIST
          from hetero2.decoys_rewire import generate_rewire_decoys
          
          out_dir = Path("out_value_m2")
          suite_dir = out_dir / "suite"
          k_decoys = int(os.environ.get("K_DECOYS", "20"))
          scores_seed = int(os.environ.get("SCORES_SEED", "0"))
          
          # Generate full decoy hash set deterministically (seed=0) for each seed SMILES.
          all_hashes = []
          for _, smiles in SMILES_LIST:
              decoys = generate_rewire_decoys(
                  smiles,
                  k=k_decoys,
                  seed=0,
                  max_attempts=None,
                  lock_aromatic=True,
                  allow_ring_bonds=False,
              )
              for d in decoys.decoys:
                  all_hashes.append(str(d["hash"]))
          all_hashes = sorted(set(all_hashes))
          if not all_hashes:
              raise SystemExit("No decoy hashes generated; cannot build scores variants")
          
          def write_payload(path: Path, *, kind: str) -> None:
              if kind == "BAD-constant":
                  original = {"score": 0.5, "weight": 1.0}
                  decoys = {h: {"score": 0.5, "weight": 1.0} for h in all_hashes}
              elif kind == "BAD-random":
                  rng = np.random.default_rng(scores_seed)
                  original = {"score": 0.5, "weight": 1.0}
                  decoys = {h: {"score": float(rng.random()), "weight": 1.0} for h in all_hashes}
              elif kind == "GOOD-synthetic":
                  original = {"score": 1.0, "weight": 1.0}
                  decoys = {h: {"score": 0.0, "weight": 1.0} for h in all_hashes}
              else:
                  raise ValueError(f"Unknown kind: {kind}")
          
              payload = {"schema_version": "hetero_scores.v1", "original": original, "decoys": decoys}
              path.write_text(json.dumps(payload, ensure_ascii=False, indent=2) + "\n", encoding="utf-8")
          
          scores_dir = out_dir / "scores"
          scores_dir.mkdir(parents=True, exist_ok=True)
          write_payload(scores_dir / "bad_constant.json", kind="BAD-constant")
          write_payload(scores_dir / "bad_random.json", kind="BAD-random")
          write_payload(scores_dir / "good_synthetic.json", kind="GOOD-synthetic")
          print(f"OK: wrote scores variants with n_hashes={len(all_hashes)} into {scores_dir}")
          PY
        env:
          K_DECOYS: ${{ inputs.k_decoys }}
          SCORES_SEED: ${{ inputs.scores_seed }}

      - name: Run hetero2-batch (BAD-constant)
        run: |
          hetero2-batch \
            --input out_value_m2/suite/input.csv \
            --out_dir out_value_m2/bad_constant \
            --artifacts light \
            --score_mode external_scores \
            --scores_input out_value_m2/scores/bad_constant.json \
            --k_decoys ${{ inputs.k_decoys }} \
            --workers 2 \
            --timeout_s 60 \
            --maxtasksperchild 100 \
            --seed_strategy global \
            --seed 0 \
            --zip_pack

      - name: Run hetero2-batch (BAD-random)
        run: |
          hetero2-batch \
            --input out_value_m2/suite/input.csv \
            --out_dir out_value_m2/bad_random \
            --artifacts light \
            --score_mode external_scores \
            --scores_input out_value_m2/scores/bad_random.json \
            --k_decoys ${{ inputs.k_decoys }} \
            --workers 2 \
            --timeout_s 60 \
            --maxtasksperchild 100 \
            --seed_strategy global \
            --seed 0 \
            --zip_pack

      - name: Run hetero2-batch (GOOD-synthetic)
        run: |
          hetero2-batch \
            --input out_value_m2/suite/input.csv \
            --out_dir out_value_m2/good_synthetic \
            --artifacts light \
            --score_mode external_scores \
            --scores_input out_value_m2/scores/good_synthetic.json \
            --k_decoys ${{ inputs.k_decoys }} \
            --workers 2 \
            --timeout_s 60 \
            --maxtasksperchild 100 \
            --seed_strategy global \
            --seed 0 \
            --zip_pack

      - name: Validate zips (no unpack)
        run: |
          for v in bad_constant bad_random good_synthetic; do
            python -m zipfile -t "out_value_m2/${v}/evidence_pack.zip"
            python -m zipfile -l "out_value_m2/${v}/evidence_pack.zip" | grep -E "manifest.json|checksums.sha256|metrics.json|index.md|summary.csv|input.csv"
          done

      - name: "Gate: ERROR must be 0 (all variants)"
        run: |
          python - << 'PY'
          import json
          from pathlib import Path
          
          for v in ["bad_constant", "bad_random", "good_synthetic"]:
              m = json.loads(Path(f"out_value_m2/{v}/metrics.json").read_text(encoding="utf-8"))
              err = int(m.get("counts", {}).get("ERROR", 0))
              if err != 0:
                  raise SystemExit(f"Gate-M2 failed: variant={v} ERROR={err}")
          print("Gate OK: ERROR=0 (all variants)")
          PY

      - name: Prepare assets
        run: |
          cp out_value_m2/bad_constant/evidence_pack.zip out_value_m2/value_m2_bad_constant_evidence_pack.zip
          cp out_value_m2/bad_random/evidence_pack.zip out_value_m2/value_m2_bad_random_evidence_pack.zip
          cp out_value_m2/good_synthetic/evidence_pack.zip out_value_m2/value_m2_good_synthetic_evidence_pack.zip

      - name: Compute SHA256
        id: hash
        run: |
          BAD_CONST=$(sha256sum out_value_m2/value_m2_bad_constant_evidence_pack.zip | awk '{print toupper($1)}')
          BAD_RAND=$(sha256sum out_value_m2/value_m2_bad_random_evidence_pack.zip | awk '{print toupper($1)}')
          GOOD_SYN=$(sha256sum out_value_m2/value_m2_good_synthetic_evidence_pack.zip | awk '{print toupper($1)}')
          echo "$BAD_CONST  value_m2_bad_constant_evidence_pack.zip" > out_value_m2/value_m2_bad_constant_evidence_pack.zip.sha256
          echo "$BAD_RAND  value_m2_bad_random_evidence_pack.zip" > out_value_m2/value_m2_bad_random_evidence_pack.zip.sha256
          echo "$GOOD_SYN  value_m2_good_synthetic_evidence_pack.zip" > out_value_m2/value_m2_good_synthetic_evidence_pack.zip.sha256
          BAD_CONST="$BAD_CONST" BAD_RAND="$BAD_RAND" GOOD_SYN="$GOOD_SYN" python - << 'PY'
          import json
          import os
          
          payload = {
              "bad_constant": os.environ["BAD_CONST"],
              "bad_random": os.environ["BAD_RAND"],
              "good_synthetic": os.environ["GOOD_SYN"],
          }
          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as f:
              f.write("sha256_json=" + json.dumps(payload, sort_keys=True) + "\n")
          PY

      - name: Summarize variants (counts + median slack + pass-rate + top SKIP)
        id: summary
        run: |
          python - << 'PY'
          import csv
          import json
          import math
          import os
          from collections import Counter
          from pathlib import Path
          
          def safe_float(x: str) -> float | None:
              try:
                  if x is None:
                      return None
                  s = str(x).strip()
                  if not s:
                      return None
                  v = float(s)
                  if math.isnan(v):
                      return None
                  return v
              except Exception:
                  return None
          
          def median(vals: list[float]) -> float | None:
              if not vals:
                  return None
              vals = sorted(vals)
              n = len(vals)
              mid = n // 2
              if n % 2 == 1:
                  return float(vals[mid])
              return float((vals[mid - 1] + vals[mid]) / 2.0)
          
          out = {}
          for v in ["bad_constant", "bad_random", "good_synthetic"]:
              summary_path = Path(f"out_value_m2/{v}/summary.csv")
              rows = list(csv.DictReader(summary_path.read_text(encoding="utf-8").splitlines()))
              total = len(rows)
              status_counts = Counter((r.get("status") or "").strip() for r in rows)
              skip_reasons = Counter(
                  (r.get("reason") or "").strip()
                  for r in rows
                  if (r.get("status") or "").strip() == "SKIP"
              )
              top_skip = skip_reasons.most_common(5)
          
              slack_vals = []
              pass_count = 0
              gate_count = 0
              rows_with_decoys = 0
              for r in rows:
                  raw_nd = (r.get("n_decoys") or "").strip()
                  try:
                      nd = int(raw_nd) if raw_nd else 0
                  except ValueError:
                      nd = 0
                  if nd > 0:
                      rows_with_decoys += 1
          
                  s = safe_float(r.get("slack"))
                  if s is not None:
                      slack_vals.append(s)
          
                  gate = (r.get("gate") or "").strip()
                  if gate:
                      gate_count += 1
                      if gate.upper() == "PASS":
                          pass_count += 1
          
              out[v] = {
                  "rows_total": total,
                  "status_counts": {k: int(vv) for k, vv in status_counts.items() if k},
                  "top_skip_reasons": [{"reason": r, "count": int(c)} for r, c in top_skip],
                  "median_slack": median(slack_vals),
                  "pass_rate": (pass_count / gate_count) if gate_count else None,
                  "share_rows_with_n_decoys_gt_0": (rows_with_decoys / total) if total else 0.0,
              }
          
          summary_json = json.dumps(out, sort_keys=True)
          Path("out_value_m2/value_m2_summary.json").write_text(summary_json + "\n", encoding="utf-8")
          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as f:
              f.write("summary_json=" + summary_json + "\n")
          
          for v, d in out.items():
              print(v, d)
          PY

      - name: Write release notes
        run: |
          python - << 'PY'
          import json
          import os
          from pathlib import Path
          
          sha256 = json.loads(os.environ["SHA256_JSON"])
          summary = json.loads(os.environ["SUMMARY_JSON"])
          
          def fmt_rate(x):
              if x is None:
                  return "NA"
              return f"{x*100:.1f}%"
          
          lines = []
          lines.append("VALUE-M2 known bad / good evidence packs (ring-suite input, external scores)")
          lines.append("")
          lines.append(f"- Source ref: {os.environ['SOURCE_REF']}")
          lines.append("- Frozen input generation:")
          lines.append(f"  python scripts/pilot_generate_input.py --out_dir out_value_m2/suite --rows {os.environ['SUITE_ROWS']} --k_decoys {os.environ['K_DECOYS']} --seed 0 --full_cover_count 3")
          lines.append("- Batch (repro; seed_strategy=global, seed=0):")
          lines.append(f"  hetero2-batch --input out_value_m2/suite/input.csv --out_dir out_value_m2/<variant> --artifacts light --score_mode external_scores --scores_input out_value_m2/scores/<variant>.json --k_decoys {os.environ['K_DECOYS']} --workers 2 --timeout_s 60 --maxtasksperchild 100 --seed_strategy global --seed 0 --zip_pack")
          lines.append("")
          lines.append("## Variants summary (from summary.csv)")
          lines.append("")
          lines.append("| variant | OK | SKIP | ERROR | median_slack | PASS-rate | share(n_decoys>0) | top_skip_reasons |")
          lines.append("| --- | ---:| ---:| ---:| ---:| ---:| ---:| --- |")
          for v, label in [("bad_constant","BAD-constant"),("bad_random","BAD-random"),("good_synthetic","GOOD-synthetic")]:
              d = summary[v]
              sc = d.get("status_counts", {})
              ok = int(sc.get("OK", 0))
              sk = int(sc.get("SKIP", 0))
              er = int(sc.get("ERROR", 0))
              med = d.get("median_slack")
              med_s = "NA" if med is None else f"{float(med):.4f}"
              pr = fmt_rate(d.get("pass_rate"))
              share = float(d.get("share_rows_with_n_decoys_gt_0") or 0.0) * 100.0
              top = d.get("top_skip_reasons") or []
              top_s = ", ".join([f\"{t['reason']}:{t['count']}\" for t in top]) if top else "(none)"
              lines.append(f\"| {label} | {ok} | {sk} | {er} | {med_s} | {pr} | {share:.1f}% | {top_s} |\")
          lines.append("")
          lines.append("## Assets")
          lines.append(f\"- value_m2_bad_constant_evidence_pack.zip SHA256: {sha256['bad_constant']}\")
          lines.append(f\"- value_m2_bad_random_evidence_pack.zip SHA256: {sha256['bad_random']}\")
          lines.append(f\"- value_m2_good_synthetic_evidence_pack.zip SHA256: {sha256['good_synthetic']}\")
          
          Path("release_notes.md").write_text("\n".join(lines) + "\n", encoding="utf-8")
          PY
        env:
          SOURCE_REF: ${{ inputs.ref }}
          SUITE_ROWS: ${{ inputs.suite_rows }}
          K_DECOYS: ${{ inputs.k_decoys }}
          SHA256_JSON: ${{ steps.hash.outputs.sha256_json }}
          SUMMARY_JSON: ${{ steps.summary.outputs.summary_json }}

      - name: Prepare meta (asset URLs, source SHA)
        id: meta
        run: |
          SOURCE_SHA=$(git rev-parse HEAD)
          echo "source_sha=$SOURCE_SHA" >> "$GITHUB_OUTPUT"
          python - << 'PY'
          import json
          import os
          
          repo = os.environ["GITHUB_REPOSITORY"]
          tag = os.environ["TAG"]
          assets = {
              "bad_constant": f"https://github.com/{repo}/releases/download/{tag}/value_m2_bad_constant_evidence_pack.zip",
              "bad_random": f"https://github.com/{repo}/releases/download/{tag}/value_m2_bad_random_evidence_pack.zip",
              "good_synthetic": f"https://github.com/{repo}/releases/download/{tag}/value_m2_good_synthetic_evidence_pack.zip",
          }
          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as f:
              f.write("asset_urls_json=" + json.dumps(assets, sort_keys=True) + "\n")
          PY
        env:
          TAG: ${{ inputs.tag }}

      - name: Upload build artifacts (zips + sha256 + notes)
        uses: actions/upload-artifact@v4
        with:
          name: value-m2-known-bad-good
          path: |
            out_value_m2/value_m2_bad_constant_evidence_pack.zip
            out_value_m2/value_m2_bad_constant_evidence_pack.zip.sha256
            out_value_m2/value_m2_bad_random_evidence_pack.zip
            out_value_m2/value_m2_bad_random_evidence_pack.zip.sha256
            out_value_m2/value_m2_good_synthetic_evidence_pack.zip
            out_value_m2/value_m2_good_synthetic_evidence_pack.zip.sha256
            out_value_m2/value_m2_summary.json
            release_notes.md

  publish-release:
    needs: build-packs
    runs-on: ubuntu-latest

    steps:
      - uses: actions/download-artifact@v4
        with:
          name: value-m2-known-bad-good
          path: .

      - name: "Gate: required CI contexts must be success"
        env:
          SOURCE_SHA: ${{ needs.build-packs.outputs.source_sha }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python - << 'PY'
          import json
          import os
          import sys
          import urllib.request
          
          repo = os.environ["GITHUB_REPOSITORY"]
          sha = os.environ["SOURCE_SHA"]
          token = os.environ["GITHUB_TOKEN"]
          
          url = f"https://api.github.com/repos/{repo}/commits/{sha}/status"
          req = urllib.request.Request(
              url,
              headers={
                  "Authorization": f"token {token}",
                  "Accept": "application/vnd.github+json",
              },
          )
          with urllib.request.urlopen(req) as resp:
              data = json.load(resp)
          
          latest_by_context = {}
          for st in data.get("statuses", []):
              ctx = st.get("context", "")
              if ctx and ctx not in latest_by_context:
                  latest_by_context[ctx] = st.get("state", "")
          
          required = ["ci/test", "ci/test-chem", "ci/docker"]
          missing = [c for c in required if c not in latest_by_context]
          bad = [c for c in required if latest_by_context.get(c) != "success"]
          
          if missing or bad:
              print("Gate-Required-Contexts failed")
              print(f"source_sha={sha}")
              print(f"missing={missing}")
              print("states=" + json.dumps({c: latest_by_context.get(c) for c in required}, indent=2, sort_keys=True))
              sys.exit(1)
          
          print("Gate OK: required contexts success")
          print(f"source_sha={sha}")
          for c in required:
              print(f"{c}=success")
          PY

      - name: Create/Update GitHub Release + upload assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.tag }}
          target_commitish: ${{ needs.build-packs.outputs.source_sha }}
          name: "VALUE-M2 known bad/good evidence packs (ERROR=0)"
          body_path: release_notes.md
          prerelease: ${{ inputs.prerelease }}
          files: |
            out_value_m2/value_m2_bad_constant_evidence_pack.zip
            out_value_m2/value_m2_bad_constant_evidence_pack.zip.sha256
            out_value_m2/value_m2_bad_random_evidence_pack.zip
            out_value_m2/value_m2_bad_random_evidence_pack.zip.sha256
            out_value_m2/value_m2_good_synthetic_evidence_pack.zip
            out_value_m2/value_m2_good_synthetic_evidence_pack.zip.sha256
            out_value_m2/value_m2_summary.json
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  registry-pr:
    needs: [build-packs, publish-release]
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          ref: "main"

      - name: Update artefacts registry (append)
        run: |
          mkdir -p docs
          FILE="docs/artefacts_registry.md"
          if [ ! -f "$FILE" ]; then
            echo "# Artefacts Registry" > "$FILE"
            echo "" >> "$FILE"
          fi

          python - << 'PY'
          import json
          from pathlib import Path
          
          file_path = Path("docs/artefacts_registry.md")
          tag = "${{ inputs.tag }}"
          source_sha = "${{ needs.build-packs.outputs.source_sha }}"
          asset_urls = json.loads(r"""${{ needs.build-packs.outputs.asset_urls_json }}""")
          sha256 = json.loads(r"""${{ needs.build-packs.outputs.sha256_json }}""")
          summary = json.loads(r"""${{ needs.build-packs.outputs.summary_json }}""")
          
          def fmt_rate(x):
              if x is None:
                  return "NA"
              return f"{x*100:.1f}%"
          
          lines = []
          lines.append("")
          lines.append(f"## {tag}")
          lines.append("")
          lines.append(f"- Source commit: {source_sha}")
          lines.append("- Release assets:")
          lines.append(f"  - BAD-constant: {asset_urls['bad_constant']}")
          lines.append(f"    - SHA256(value_m2_bad_constant_evidence_pack.zip): {sha256['bad_constant']}")
          lines.append(f"  - BAD-random: {asset_urls['bad_random']}")
          lines.append(f"    - SHA256(value_m2_bad_random_evidence_pack.zip): {sha256['bad_random']}")
          lines.append(f"  - GOOD-synthetic: {asset_urls['good_synthetic']}")
          lines.append(f"    - SHA256(value_m2_good_synthetic_evidence_pack.zip): {sha256['good_synthetic']}")
          lines.append("- Command:")
          lines.append("  python scripts/pilot_generate_input.py --out_dir out_value_m2/suite --rows ${{ inputs.suite_rows }} --k_decoys ${{ inputs.k_decoys }} --seed 0 --full_cover_count 3")
          lines.append("  hetero2-batch --input out_value_m2/suite/input.csv --out_dir out_value_m2/<variant> --artifacts light --score_mode external_scores --scores_input out_value_m2/scores/<variant>.json --k_decoys ${{ inputs.k_decoys }} --workers 2 --timeout_s 60 --maxtasksperchild 100 --seed_strategy global --seed 0 --zip_pack")
          lines.append("- Outcome (acceptance evidence):")
          lines.append("")
          lines.append("| variant | OK | SKIP | ERROR | median_slack | PASS-rate | share(n_decoys>0) | top_skip_reasons |")
          lines.append("| --- | ---:| ---:| ---:| ---:| ---:| ---:| --- |")
          for key, label in [("bad_constant","BAD-constant"),("bad_random","BAD-random"),("good_synthetic","GOOD-synthetic")]:
              d = summary[key]
              sc = d.get("status_counts", {})
              ok = int(sc.get("OK", 0))
              sk = int(sc.get("SKIP", 0))
              er = int(sc.get("ERROR", 0))
              med = d.get("median_slack")
              med_s = "NA" if med is None else f"{float(med):.4f}"
              pr = fmt_rate(d.get("pass_rate"))
              share = float(d.get("share_rows_with_n_decoys_gt_0") or 0.0) * 100.0
              top = d.get("top_skip_reasons") or []
              top_s = ", ".join([f\"{t['reason']}:{t['count']}\" for t in top]) if top else "(none)"
              lines.append(f"| {label} | {ok} | {sk} | {er} | {med_s} | {pr} | {share:.1f}% | {top_s} |")
          
          file_path.write_text(file_path.read_text(encoding="utf-8") + "\n".join(lines) + "\n", encoding="utf-8")
          print(f"OK: appended registry entry for {tag}")
          PY

      - name: Create PR with registry update
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: "automation/artefact-${{ inputs.tag }}"
          title: "Add artefact registry entry for ${{ inputs.tag }}"
          commit-message: "docs: add artefact registry entry for ${{ inputs.tag }}"
          body: |
            Automated update: appended artefact entry after publishing VALUE-M2 assets.
          base: "main"
          add-paths: |
            docs/artefacts_registry.md
